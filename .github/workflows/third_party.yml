# This workflow is a daily cron job, inspired by https://github.com/python/typing_extensions/blob/main/.github/workflows/third_party.yml
# running the tests of various third-party libraries that use pydantic. This helps us spot regressions early,
# and helps flag when third-party libraries are making incorrect assumptions that might cause them to break when we cut a new release.

name: third party tests

on:
  schedule:
    - cron: '0 12 * * *' # Daily at midnight UTC
  pull_request:
    branches:
      - main

  # Can be manually triggered from the Actions tab, if needed
  workflow_dispatch:

permissions:
  contents: read

env:
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  FORCE_COLOR: 1
  PROCEED_WITH_TESTS: ${{ contains(github.event.pull_request.labels.*.name, 'third-party-tests') || github.event_name == 'schedule' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  test-condition:
    runs-on: ubuntu-latest
    steps:
    - name: check if we should proceed with tests
      run: |
        echo "PROCEED_WITH_TESTS=${{ env.PROCEED_WITH_TESTS }}"
        echo "PROCEED_WITH_TESTS=${{ github.env.PROCEED_WITH_TESTS }}"
    
    - name: Manual check for label
      run: |
        echo "PROCEED_WITH_TESTS=${{ github.event.pull_request.labels.*.name }}"
        echo "PROCEED_WITH_TESTS=${{ github.event_name }}"
        echo "PROCEED_WITH_TESTS=${{ contains(github.event.pull_request.labels.*.name, 'third-party-tests') }}"
        echo $$ {{ env.PROCEED_WITH_TESTS }}

  test-fastapi:
    if: ${{ github.env.PROCEED_WITH_TESTS == 'true' }}
    name: test fastapi (`main` branch) on python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12', '3.13']
    steps:
    - uses: actions/checkout@v4

    - uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        python-version: ${{ matrix.python-version }}

    - name: checkout fastapi
      run: git clone https://github.com/tiangolo/fastapi.git --single-branch

    - name: checkout pydantic
      uses: actions/checkout@v4
      with:
        path: pydantic-latest

    - name: install deps
      run: |
        cd fastapi
        uv venv
        uv pip install -r requirements.txt
        uv add --editable ../pydantic-latest

    - name: list installed dependencies
      run: cd fastapi; uv pip list

    - name: run fastapi tests
      run: cd fastapi; uv run ./scripts/test.sh -vv

    # TODO: slack notification on failure, if job was scheduled
